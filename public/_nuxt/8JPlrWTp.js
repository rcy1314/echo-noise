import{p as M,a4 as z,I as g,a9 as q,aj as k,O as D,k as S,r as p,E as H,F as $,Q as r,R as e,x as s,aa as J,h as o,$ as L,a5 as P,v as T,V as Q,a2 as W,T as Y,U as b,a1 as K,Y as X}from"./B5Ug7n5G.js";import{_ as Z,a as tt}from"./D4kD5da7.js";import{_ as et,a as ot}from"./CvsaU5XD.js";import{_ as st}from"./Hw1Pf6vM.js";import{s as nt}from"./x_rD_Ya3.js";const at={class:"fixed inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-800"},lt={class:"relative z-10 flex min-h-screen items-center justify-center p-4"},it={class:"flex items-center justify-between mb-4"},rt={class:"flex items-center gap-2"},dt={class:"flex justify-between items-center mb-3"},ut={key:0,class:"mt-2"},ct={class:"flex justify-end gap-2"},wt=M({__name:"login",setup(mt){const V=z(),U=g(),E=q(),C=k(),w=D().public.baseApi||"/api",u=S({username:"",password:""}),f=p(!1),j=p(!0),_=p(!1),h=S({account:""}),c=p(0);let v=null;const y=p(!0),F=p(!0),I=async()=>{f.value=!0;const l=new AbortController,t=setTimeout(()=>{l.abort(),g().add({title:"登录失败",description:"请求超时或服务器不可用",color:"red"}),f.value=!1},8e3);try{if(await V.login({username:u.username,password:u.password})){g().add({title:"登录成功",color:"green"});const n=E.query.redirect||"/status";C.push(n)}}catch{g().add({title:"登录失败",description:"请检查账号密码与后端服务",color:"red"})}finally{clearTimeout(t),f.value=!1}},N=()=>{window.location.href=`${w}/oauth/github/login`},A=async()=>{var l;try{const i=await(await fetch(`${w}/frontend/config`,{credentials:"include"})).json();if(!!!((l=i==null?void 0:i.data)!=null&&l.allowRegistration)){g().add({title:"提示",description:"站点已关闭用户注册",color:"orange"});return}k().push("/auth/register")}catch{k().push("/auth/register")}},B=async()=>{try{const l=await fetch(`${w}/password/forgot`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({account:h.account})}),t=await l.json().catch(()=>({}));if(!l.ok||t.code!==1)throw new Error((t==null?void 0:t.msg)||"发送失败");U.add({title:(t==null?void 0:t.msg)||"已发送",description:"请查收重置邮件",color:"green"}),c.value=60,v&&clearInterval(v),v=nt(()=>{c.value>0?c.value--:clearInterval(v)},1e3)}catch(l){U.add({title:"失败",description:l.message||"发送失败",color:"red"})}};return H(async()=>{var t,i,n,m;await V.checkLoginStatus()&&C.push("/status");try{const a=await(await fetch(`${w}/frontend/config`,{credentials:"include"})).json();j.value=!!((i=(t=a==null?void 0:a.data)==null?void 0:t.frontendSettings)!=null&&i.githubOAuthEnabled),y.value=!!((n=a==null?void 0:a.data)!=null&&n.smtpEnabled),F.value=!!((m=a==null?void 0:a.data)!=null&&m.allowRegistration)}catch{}}),(l,t)=>{const i=W,n=Y,m=Z,x=ot,a=et,R=P,O=st,G=tt;return T(),$(L,null,[r("div",at,[t[13]||(t[13]=r("div",{class:"absolute inset-0 backdrop-blur-xl"},null,-1)),r("div",lt,[e(R,{class:"w-full max-w-md bg-slate-900/70 text-white border border-slate-700/40 shadow-2xl"},{default:s(()=>[r("div",it,[r("div",rt,[e(i,{name:"i-heroicons-lock-closed",class:"w-6 h-6 text-indigo-300"}),t[6]||(t[6]=r("h1",{class:"text-lg font-semibold"},"登录",-1))]),e(n,{variant:"link",color:"indigo",class:"text-sm",onClick:A},{default:s(()=>t[7]||(t[7]=[b("去注册")])),_:1})]),e(a,{onSubmit:K(I,["prevent"])},{default:s(()=>[e(x,{label:"用户名",class:"mb-3"},{default:s(()=>[e(m,{modelValue:o(u).username,"onUpdate:modelValue":t[0]||(t[0]=d=>o(u).username=d),placeholder:"请输入用户名"},null,8,["modelValue"])]),_:1}),e(x,{label:"密码",class:"mb-2"},{default:s(()=>[e(m,{modelValue:o(u).password,"onUpdate:modelValue":t[1]||(t[1]=d=>o(u).password=d),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])]),_:1}),r("div",dt,[e(n,{variant:"ghost",size:"sm",onClick:t[2]||(t[2]=d=>_.value=!0)},{default:s(()=>t[8]||(t[8]=[b("忘记密码")])),_:1}),e(n,{loading:o(f),disabled:o(f),type:"submit",color:"primary"},{default:s(()=>t[9]||(t[9]=[b("登录")])),_:1},8,["loading","disabled"])])]),_:1}),o(j)?(T(),$("div",ut,[e(n,{class:"w-full h-10 px-3 gap-2 justify-center font-medium bg-[#24292f] hover:bg-[#1f2328] text-white ring-1 ring-black/20",onClick:N},{default:s(()=>[e(i,{name:"i-mdi-github",class:"w-5 h-5"}),t[10]||(t[10]=r("span",null,"GitHub 一键登录",-1))]),_:1})])):Q("",!0)]),_:1})]),e(O,{modelValue:o(_),"onUpdate:modelValue":t[5]||(t[5]=d=>J(_)?_.value=d:null)},{default:s(()=>[e(R,{class:"bg-slate-900/80 text-white border border-slate-700/40"},{default:s(()=>[t[12]||(t[12]=r("div",{class:"font-semibold mb-2"},"找回密码",-1)),e(a,{onSubmit:B},{default:s(()=>[e(x,{label:"用户名或邮箱",class:"mb-3"},{default:s(()=>[e(m,{modelValue:o(h).account,"onUpdate:modelValue":t[3]||(t[3]=d=>o(h).account=d),placeholder:"请输入用户名或邮箱"},null,8,["modelValue"])]),_:1}),r("div",ct,[e(n,{variant:"ghost",onClick:t[4]||(t[4]=d=>_.value=!1)},{default:s(()=>t[11]||(t[11]=[b("取消")])),_:1}),e(n,{disabled:o(c)>0||!o(y),type:"submit",color:"primary"},{default:s(()=>[b(X(o(y)?o(c)>0?`请稍候(${o(c)}s)`:"发送重置邮件":"邮件未开启"),1)]),_:1},8,["disabled"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e(G)],64)}}});export{wt as default};
