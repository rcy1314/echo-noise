import{p as M,a8 as O,U as g,ac as q,af as k,$ as J,k as $,r as f,E as L,q as R,K as i,I as e,J as s,ad as D,h as o,L as H,a1 as K,v as E,G as P,a2 as W,a4 as Q,y as b,a6 as X,z as Y}from"./DAyM6u0O.js";import{a as Z,_ as tt,c as et}from"./BSuUlSAy.js";import{_ as ot}from"./DLWNtYUj.js";import{_ as st}from"./BkEOo76i.js";import{s as nt}from"./x_rD_Ya3.js";const at={class:"fixed inset-0 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-800"},lt={class:"relative z-10 flex min-h-screen items-center justify-center p-4"},rt={class:"flex items-center justify-between mb-4"},it={class:"flex items-center gap-2"},ut={class:"flex justify-between items-center mb-3"},dt={key:0,class:"mt-2"},ct={class:"flex justify-end gap-2"},wt=M({__name:"login",setup(mt){const V=O(),U=g(),T=q(),C=k(),w=J().public.baseApi||"/api",d=$({username:"",password:""}),p=f(!1),j=f(!0),_=f(!1),x=$({account:""}),c=f(0);let v=null;const y=f(!0),I=f(!0),N=async()=>{p.value=!0;const l=new AbortController,t=setTimeout(()=>{l.abort(),g().add({title:"登录失败",description:"请求超时或服务器不可用",color:"red"}),p.value=!1},8e3);try{if(await V.login({username:d.username,password:d.password})){g().add({title:"登录成功",color:"green"});const n=T.query.redirect||"/status";C.push(n)}}catch{g().add({title:"登录失败",description:"请检查账号密码与后端服务",color:"red"})}finally{clearTimeout(t),p.value=!1}},F=()=>{window.location.href=`${w}/oauth/github/login`},z=async()=>{var l;try{const r=await(await fetch(`${w}/frontend/config`,{credentials:"include"})).json();if(!!!((l=r==null?void 0:r.data)!=null&&l.allowRegistration)){g().add({title:"提示",description:"站点已关闭用户注册",color:"orange"});return}k().push("/auth/register")}catch{k().push("/auth/register")}},A=async()=>{try{const l=await fetch(`${w}/password/forgot`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({account:x.account})}),t=await l.json().catch(()=>({}));if(!l.ok||t.code!==1)throw new Error((t==null?void 0:t.msg)||"发送失败");U.add({title:(t==null?void 0:t.msg)||"已发送",description:"请查收重置邮件",color:"green"}),c.value=60,v&&clearInterval(v),v=nt(()=>{c.value>0?c.value--:clearInterval(v)},1e3)}catch(l){U.add({title:"失败",description:l.message||"发送失败",color:"red"})}};return L(async()=>{var t,r,n,m;await V.checkLoginStatus()&&C.push("/status");try{const a=await(await fetch(`${w}/frontend/config`,{credentials:"include"})).json();j.value=!!((r=(t=a==null?void 0:a.data)==null?void 0:t.frontendSettings)!=null&&r.githubOAuthEnabled),y.value=!!((n=a==null?void 0:a.data)!=null&&n.smtpEnabled),I.value=!!((m=a==null?void 0:a.data)!=null&&m.allowRegistration)}catch{}}),(l,t)=>{const r=W,n=Q,m=tt,h=ot,a=Z,S=K,B=st,G=et;return E(),R(H,null,[i("div",at,[t[13]||(t[13]=i("div",{class:"absolute inset-0 backdrop-blur-xl"},null,-1)),i("div",lt,[e(S,{class:"w-full max-w-md bg-slate-900/70 text-white border border-slate-700/40 shadow-2xl"},{default:s(()=>[i("div",rt,[i("div",it,[e(r,{name:"i-heroicons-lock-closed",class:"w-6 h-6 text-indigo-300"}),t[6]||(t[6]=i("h1",{class:"text-lg font-semibold"},"登录",-1))]),e(n,{variant:"link",color:"indigo",class:"text-sm",onClick:z},{default:s(()=>t[7]||(t[7]=[b("去注册")])),_:1})]),e(a,{onSubmit:X(N,["prevent"])},{default:s(()=>[e(h,{label:"用户名/已绑定邮箱",class:"mb-3"},{default:s(()=>[e(m,{modelValue:o(d).username,"onUpdate:modelValue":t[0]||(t[0]=u=>o(d).username=u),placeholder:"请输入用户名或已绑定邮箱"},null,8,["modelValue"])]),_:1}),e(h,{label:"密码",class:"mb-2"},{default:s(()=>[e(m,{modelValue:o(d).password,"onUpdate:modelValue":t[1]||(t[1]=u=>o(d).password=u),type:"password",placeholder:"请输入密码",autocomplete:"current-password",autocorrect:"off",autocapitalize:"off",spellcheck:"false"},null,8,["modelValue"])]),_:1}),i("div",ut,[e(n,{variant:"ghost",size:"sm",onClick:t[2]||(t[2]=u=>_.value=!0)},{default:s(()=>t[8]||(t[8]=[b("忘记密码")])),_:1}),e(n,{loading:o(p),disabled:o(p),type:"submit",color:"primary"},{default:s(()=>t[9]||(t[9]=[b("登录")])),_:1},8,["loading","disabled"])])]),_:1}),o(j)?(E(),R("div",dt,[e(n,{class:"w-full h-10 px-3 gap-2 justify-center font-medium bg-[#24292f] hover:bg-[#1f2328] text-white ring-1 ring-black/20",onClick:F},{default:s(()=>[e(r,{name:"i-mdi-github",class:"w-5 h-5"}),t[10]||(t[10]=i("span",null,"GitHub 一键登录",-1))]),_:1})])):P("",!0)]),_:1})]),e(B,{modelValue:o(_),"onUpdate:modelValue":t[5]||(t[5]=u=>D(_)?_.value=u:null)},{default:s(()=>[e(S,{class:"bg-slate-900/80 text-white border border-slate-700/40"},{default:s(()=>[t[12]||(t[12]=i("div",{class:"font-semibold mb-2"},"找回密码",-1)),e(a,{onSubmit:A},{default:s(()=>[e(h,{label:"用户名或邮箱",class:"mb-3"},{default:s(()=>[e(m,{modelValue:o(x).account,"onUpdate:modelValue":t[3]||(t[3]=u=>o(x).account=u),placeholder:"请输入用户名或邮箱"},null,8,["modelValue"])]),_:1}),i("div",ct,[e(n,{variant:"ghost",onClick:t[4]||(t[4]=u=>_.value=!1)},{default:s(()=>t[11]||(t[11]=[b("取消")])),_:1}),e(n,{disabled:o(c)>0||!o(y),type:"submit",color:"primary"},{default:s(()=>[b(Y(o(y)?o(c)>0?`请稍候(${o(c)}s)`:"发送重置邮件":"邮件未开启"),1)]),_:1},8,["disabled"])])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),e(G)],64)}}});export{wt as default};
